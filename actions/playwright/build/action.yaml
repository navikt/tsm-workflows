name: "Builds a speedy demo version of the app and pushes it to Github Package Registry"
description: "Enables you to use the container in as a service container in your e2e execution step"

inputs:
  GITHUB_TOKEN:
    description: 'GitHub authentication token (usually secrets.GITHUB_TOKEN)'
    required: true
    type: string

outputs:
  image:
    description: "Docker image in Github Package Registry"
    value: ghcr.io/${{ github.repository }}-e2e:${{ github.sha }}

runs:
  using: composite
  steps:
    - uses: actions/checkout@v5
    - uses: navikt/tsm-workflows/actions/yarn@main
      with:
        READER_TOKEN: ${{ inputs.GITHUB_TOKEN }}
    - name: Build e2e version of app
      shell: bash
      run: |
        cp .nais/envs/.env.demo .env.production
        yarn build:e2e
      env:
        NEXT_PUBLIC_VERSION: ${{ github.sha }}
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.GITHUB_TOKEN }}
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}-e2e:${{ github.sha }}
